<!DOCTYPE html>
<html lang="en-us">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Implementing Disney Principled BRDF in Arnold</title>

    

    
    <link href="http://shihchin.com/css/bootstrap.css" rel="stylesheet">

    
    <link href="http://shihchin.com/css/clean-blog.css" rel="stylesheet">

    
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic|Open+Sans:400italic,600italic,400,600|Coda:800)' media='screen' rel='stylesheet' type='text/css'/>

    
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
    <link rel="stylesheet" href="http://shihchin.com/css/prettyprint.css">
    

    <link rel="stylesheet" href="http://shihchin.com/css/lightbox.css">

    
    
    

    
    <script type='text/x-mathjax-config'>
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ['\\(','\\)'] ]
            },
            processEscapes: true,
            processEnvironments: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            TeX: {
                equationNumbers: { autoNumber: "AMS" },
                extensions: ["AMSmath.js", "AMSsymbols.js"]
            },
            "HTML-CSS": {
                preferredFont: "TEX",
                scale : 85
            }
        });
    </script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"></script>

    <link rel="stylesheet" type="text/css" href="http://shihchin.com/css/foundation.css">
    <link rel="stylesheet" type="text/css" href="http://shihchin.com/css/twentytwenty.css">
    <link rel="stylesheet" type="text/css" href="http://shihchin.com/css/header-anchor.css">
    <link rel="shortcut icon" type="image/png" href="http://shihchin.com/favicon.png">

    <style>
    .intro-header .overlay {
        background: rgba(0, 0, 0, 0.47);
        z-index: 1;
        width: 100%;
        height: 100%;
        top: 0;
    }

    p + ul { margin-top: -24px; }
    p + ol { margin-top: -24px; }
    h1 + p, h2 + p, h3 + p { margin-top: 15px; }

    .summary-content {
        text-align: justify;
        margin: 5px 0px 5px 0px;
    }

    a.read-more-link {
        text-decoration: none;
        color: #FF9800;
        font-weight: bolder;
        margin-left: 5px;
    }

    code > div > .table {
        margin-bottom: 0px;
        padding: 0px;
    }

    code > div > .table > tbody > tr > td {
        border-top: none;
        padding: 0px;
    }

    .container .img-responsive {
        padding: 5px;
        margin: auto;
        -moz-box-shadow: 0 0 10px rgba(0, 0, 0, .2);
        -webkit-box-shadow: 0 0 10px rgba(0, 0, 0, .2);
        box-shadow: 0 0 10px rgba(0, 0, 0, .2);
        -moz-border-radius: 5px;
        -webkit-border-radius: 5px;
        border-radius: 5px;
        margin-top: 10px;
        margin-bottom: 10px;
    }

    .twentytwenty-container .img-responsive {
        padding: 0px;
        margin: 0px auto;
        -moz-box-shadow: none;
        -webkit-box-shadow: none;
        box-shadow: none;
        border-radius: 0px;
    }

    .figure .img-responsive {
        padding: 0px;
        margin: auto;
        -moz-box-shadow: none;
        -webkit-box-shadow: none;
        box-shadow: none;
        border-radius: 0px;
        margin-top: 0px;
        margin-bottom: 5px;
    }

    .figure {
        padding: 5px;
        margin: auto;
        -moz-box-shadow: 0 0 10px rgba(0, 0, 0, .2);
        -webkit-box-shadow: 0 0 10px rgba(0, 0, 0, .2);
        box-shadow: 0 0 10px rgba(0, 0, 0, .2);
        -moz-border-radius: 5px;
        -webkit-border-radius: 5px;
        border-radius: 5px;
        margin-top: 15px;
        margin-bottom: 15px;
        display: table;
    }

    figure figcaption {
         
        text-align: center;
        font-size: 14px;
         
        color: #808080;
    }

    .container li a {
        text-decoration: underline;
    }

    .container a:hover, a:focus {
         
        background: #A6DCF3;
        text-decoration: none;
    }

    samp {
        display: block;
        background-color: rgba(0, 55, 0, 1);
        font-size: 0.8em;
        text-align: left;
        color: rgba(0, 255, 0, 1);
        padding: 5px;
        white-space: pre-wrap;
        border-radius: 5px;
        margin: 10px 0px;
    }

    samp.error {
        color: red;
    }

    blockquote p:first-child, blockquote ul:first-child, blockquote ol:first-child {
        margin-top: 0;
    }

    .container blockquote {
         
        background: #FFF1E5;
        padding: 8px;
        margin-top: 20px;
        margin-bottom: 20px;
         
        text-align: justify;
        line-height: 1.5;
        border: dashed;
        border-color: rgb(228, 201, 196);
    }

    .container blockquote.feedback {
        white-space: pre-wrap;
    }

    blockquote time {
        font-size: 80%;
    }

    blockquote {
        color: #806565;
    }

    blockquote a {
        color: #337ab7;
    }

    span.blue {
        border-bottom: 1px solid #a6dcf3;
        box-shadow: inset 0 -6px 0 #a6dcf3;
    }
    span.orange {
        border-bottom: 1px solid #ffd8ae;
        box-shadow: inset 0 -6px 0 #ffd8ae;
    }
    span.red { color: #dc1111; }
    span.green {
        border-bottom: 1px solid #cdf9bb;
        box-shadow: inset 0 -6px 0 #cdf9bb;
    }

    .tag-box {
        list-style: none;
        margin: 0;
        padding: 4px 0;
        overflow: hidden;
    }
    .tag-box.inline li {
        float: left;
    }
    .tag-box li {
        padding: 4px 6px;
        margin: 2px;
        background-color: #e6e6e6;
        -webkit-border-radius: 4px;
        -moz-border-radius: 4px;
        border-radius: 4px;
    }
    .tag-box li a {
        text-decoration: none;
    }
    </style>

</head>

<body onload="PR.prettyPrint()">

    
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://shihchin.com">Shih-Chin</a>
            </div>
            
<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="nav navbar-nav navbar-right">
        
        <li>
            <a href="http://shihchin.com/">home</a>
        </li>
        
        <li>
            <a href="http://shihchin.com/page/computer-graphics.html">Computer Graphics</a>
        </li>
        
        <li>
            <a href="http://shihchin.com/page/global-illumination.html">Global Illumination</a>
        </li>
        
        <li>
            <a href="http://shihchin.com/page/arnold.html">Arnold</a>
        </li>
        
        <li>
            <a href="http://shihchin.com/page/maya.html">Maya</a>
        </li>
        
        <li>
            <a href="http://shihchin.com/post.html">Posts</a>
        </li>
        
        <li>
            <a href="http://shihchin.com/about/">About</a>
        </li>
        
      </ul>
</div>


        </div>
        
    </nav>


    
    
    <header class="intro-header" style="background-image: url('http://shihchin.com/images/header/posts/2015-07-19-implementing-disney-principled-brdf-in.jpg')">
    
      <div class="overlay">
        <div class="container">
          <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <div class="post-heading">
                <h1>Implementing Disney Principled BRDF in Arnold</h1>
                <h2 class="subheading"></h2>
                <span class="meta">
                 
Posted by Shih-Chin on Sun, Jul 19, 2015


               </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                  

<p>Disney &ldquo;principled&rdquo; BRDF [<a href="#ref.1">1</a>] is a very interesting shading model. It can achieve various physically plausible appearances with only one color parameter and ten scalar parameters! This shading model is designed not only to catch most of the measured data from <a href="http://www.merl.com/brdf/">MERL</a>, but also to follow the principles below:</p>

<blockquote>
<ol>
<li><strong>Intuitive</strong> rather than physical.</li>
<li>As <strong>few parameters</strong> as possible.</li>
<li>Parameters are <strong>zero to one</strong> over their plausible range.</li>
<li>Parameters are <strong>allowed to be pushed beyond</strong> their plausible range where it makes sense.</li>
<li>All combinations of parameters should be as <strong>robust and plausible</strong> as possible.</li>
</ol>
</blockquote>

<p>These art-directable features make artists achieve the desired shading results more easily, it is one of the ultimate goals for software engineering in animation studio. Since it has been implemented within various frameworks like <a href="http://blog.selfshadow.com/publications/s2013-shading-course/">Unreal Engine 4</a>, <a href="http://renderman.pixar.com/resources/current/RenderMan/PxrDisney.html">RenderMan</a>, MPC&rsquo;s preview system <a href="http://on-demand-gtc.gputechconf.com/gtcnew/on-demand-gtc.php?searchByKeyword=mpc&amp;searchItems=&amp;sessionTopic=&amp;sessionEvent=2&amp;sessionYear=2015&amp;sessionFormat=&amp;submit=&amp;select=">Dekko</a>, etc. So, let&rsquo;s make one for Arnold. :)</p>

<h1 id="importance-sampling">Importance Sampling</h1>

<p>According to the source code from BRDF explorer, the shading components can be separated into two parts:</p>

<ul>
<li>diffuse

<ul>
<li>base diffuse</li>
<li>Hanrahan-Krueger subsurface</li>
</ul></li>
<li>specular

<ul>
<li>primary specular (anisotropic GTR2)</li>
<li>clearcoat (GTR1)</li>
<li>sheen</li>
</ul></li>
</ul>

<h2 id="diffuse">Diffuse</h2>

<p>From BRDF explorer, we can see that the diffuse component is dominated by the $\cos{\theta_l}$ factor. Therefore the diffuse part could be sampled with the PDF proportional to cosine-weighted solid angle:
<img src="http://shihchin.com/images/rlShaders/rlDisney_is_diffuse.jpg" alt="diffuse sample distribution" /></p>

<h2 id="specular">Specular</h2>

<p>Sheen is relatively small to primary specular (GTR2) and clearcoat (GTR1) and it is ignored in the importance sampling process in current implementation. The importance sampling approach for GTR is pretty much like we did for GGX previously, except for the anisotropic case which is a little complicated (I&rsquo;ve not successfully derived the formula yet). Fortunately, Burley has kindly provided the details in the course notes [<a href="#ref.1">1</a>], and we could simply follow those formulas to generate samples:</p>

<p>$$\begin{eqnarray}
aspect&amp;=&amp;\sqrt{1-0.9*anisotropic} \nonumber <br />
\alpha_x&amp;=&amp;\frac{roughness^2}{aspect},\ \alpha_y=roughness^2*aspect \nonumber <br />
\end{eqnarray}$$</p>

<p>for primary anisotropic specular:</p>

<p>$$\begin{eqnarray}
D_{GTR_2aniso}&amp;=&amp;\frac{1}{\pi}\frac{1}{\alpha_x\alpha_y}\frac{1}{(\sin^2{\theta_h}(\frac{\cos^2{\phi_h}}{\alpha_x^2}+\frac{\sin^2{\phi_h}}{\alpha_y^2})+\cos^2{\theta_h})^2} \nonumber <br />
h&rsquo;&amp;=&amp;\sqrt{\frac{\xi_2}{1-\xi_2}}[\alpha_x\cos(2\pi\xi_1)\vec{u}+\alpha_y\sin(2\pi\xi_1)\vec{v}]+\vec{n},\ h=\frac{h&rsquo;}{|h&rsquo;|}
\end{eqnarray}$$</p>

<p>for clearcoat:</p>

<p>$$\begin{eqnarray}
D_{GTR_1}&amp;=&amp;\frac{\alpha^2-1}{\pi\log\alpha^2}\frac{1}{(1+(\alpha^2-1)\cos^2\theta_h)} \nonumber <br />
\cos\theta_h&amp;=&amp;\sqrt{\frac{1-(\alpha^2)^{1-\xi_2}}{1-\alpha^2}},\ \phi_h=2\pi\xi_1
\end{eqnarray}$$</p>

<p>The microfacet normal h is generated according to $D(\theta_h)\cos\theta_h$ which is already normalized over the hemisphere. Therefore, I tried to use the coefficents of $D_{GTR_2}, D_{GTR_1}$ as weights for lobe selection and PDF composition:</p>

<pre class="prettyprint linenums lang-cpp">
AtVector    sampleSpecularDirection(float rx, float ry) const
{
    // Select lobe by the relative weights.
    // Sample the microfacet normal first, then compute the reflect direction.
    AtVector M;

    float gtr2Weight = 1.0f / (mClearcoat + 1.0f);

    if (rx < gtr2Weight) {
        rx /= gtr2Weight;
        M = sampleGTR2AnisoDirection(rx, ry);
    } else {
        rx = (rx - gtr2Weight) / (1.0f - gtr2Weight);
        M = sampleGTR1Direction(rx, ry);
    }

    if (AiV3Dot(mAxisN, M) < 0.0f) {
        return AI_V3_ZERO;
    }

    return getReflectDirection(mViewDir, M);
}

float   evalSpecularPdf(const AtVector &i) const
{
    auto m = AiV3Normalize(i + mViewDir);
    auto IdotM = ABS(AiV3Dot(i, m));
    auto MdotN = AiV3Dot(m, mAxisN);

    if (MdotN < 0.0f) {
        return 0.0f;
    }

    float MdotN2 = SQR(MdotN);

    auto clearcoatWeight = mClearcoat / (mClearcoat + 1.0f);
    auto D = LERP(clearcoatWeight, D_GTR2Aniso(m, MdotN2), D_GTR1(m, MdotN2));
    return D * ABS(MdotN) * 0.25f / IdotM;
}
</pre>

<figure class="figure">
<img src="http://shihchin.com/images/rlShaders/rlDisney_is_specular_a.4_theta_10d.jpg">
<figcaption>roughness=0.4, $\theta_o=10^\circ$</figcaption></figure>

<figure class="figure">
<img src="http://shihchin.com/images/rlShaders/rlDisney_is_specular_a.4.jpg">
<figcaption>roughness=0.4, $\theta_o=45^\circ$</figcaption></figure>

<figure class="figure">
<img src="http://shihchin.com/images/rlShaders/rlDisney_is_specular_a.4_theta_80d.jpg">
<figcaption>roughness=0.4, $\theta_o=80^\circ$</figcaption></figure>

<figure class="figure">
<img src="http://shihchin.com/images/rlShaders/rlDisney_is_specular_a.8.jpg">
<figcaption>roughness=0.8, $\theta_o=45^\circ$</figcaption></figure>

<p>The <span class="red">red dots</span> at bottom represent the invalid sample whose $\theta_m$ is greater than 90 degrees (i.e. $m \cdot n &lt; 0$). It might be able to get improved by importance sampling the <span class="orange"><strong>visible</strong></span> microfacet normals presented in Heitz and d&rsquo;Eon [<a href="#ref.3">3</a>].</p>

<h1 id="removing-fireflies">Removing Fireflies</h1>

<p>Current shading model is not energy conserved, sometimes the specular part would cause fireflies in indirect diffuse pass. The noise level can be reduced by using metallic parameter to blend the diffuse and GTR parts, but it would lost the clearcoating effect for non-metal material. Another possible approach is to skip specular evaluation for indirect ray samples (i.e. AI_RAY_DIFFUSE/AI_RAY_GLOSSY) like tutorial does with the price of missing reflection of metallic material.</p>

<p><img src="http://shihchin.com/images/rlShaders/rlDisney_indirect.jpg" alt="indirect lighting" /></p>

<p>After few trial and errors, I found the most intuitive way is to use extra weights to scale the diffuse/specular radiance for indirect ray samples:</p>

<pre class="prettyprint linenums lang-cpp">
if (sg->Rt & (AI_RAY_DIFFUSE | AI_RAY_GLOSSY)) {
    diffuse *= AiShaderEvalParamFlt(p_indirect_diffuse);
    specular *= AiShaderEvalParamFlt(p_indirect_specular);
}
</pre>

<p><a href="http://shihchin.com/images/rlShaders/rlDisney_indirect_scale_control.jpg" data-lightbox="results"><img src="http://shihchin.com/images/rlShaders/rlDisney_indirect_scale_control.jpg"></a></p>

<h1 id="results">Results</h1>

<figure class="figure">
<a href="http://shihchin.com/images/rlShaders/rlDisney_metallic.jpg" data-lightbox="results"><img src="http://shihchin.com/images/rlShaders/rlDisney_metallic.jpg"></a>
<figcaption>metallic 0 to 1</figcaption></figure>

<figure class="figure">
<a href="http://shihchin.com/images/rlShaders/rlDisney_roughness.jpg" data-lightbox="results"><img src="http://shihchin.com/images/rlShaders/rlDisney_roughness.jpg"></a>
<figcaption>roughness 0 to 1</figcaption></figure>

<figure class="figure">
<a href="http://shihchin.com/images/rlShaders/rlDisney_test1.jpg" data-lightbox="results"><img src="http://shihchin.com/images/rlShaders/rlDisney_test1.jpg"></a>
<a href="http://shihchin.com/images/rlShaders/rlDisney_test2.jpg" data-lightbox="results"><img src="http://shihchin.com/images/rlShaders/rlDisney_test2.jpg"></a></figure>

<p><a href="http://shihchin.com/images/rlShaders/rlDisney_bunny_row.jpg" data-lightbox="results"><img src="http://shihchin.com/images/rlShaders/rlDisney_bunny_row.jpg"></a>
<a href="http://shihchin.com/images/rlShaders/rlDisney_lucy.jpg" data-lightbox="results"><img src="http://shihchin.com/images/rlShaders/rlDisney_lucy.jpg"></a></p>

<p>The source code could be found <a href="https://github.com/shihchinw/rlShaders/blob/master/src/rlDisney.cpp">here</a>. If you have any idea or find any bug, please let me know in the comments.</p>

<h1 id="references">References</h1>

<ol>
<li>Burley, Brent. <cite id="ref.1">&ldquo;<a href="http://blog.selfshadow.com/publications/s2012-shading-course/burley/s2012_pbs_disney_brdf_notes_v3.pdf">Physically Shading in Disney. 3/e.</a>&ldquo;</cite> SIGGRAPH 2012 <a href="http://blog.selfshadow.com/publications/s2012-shading-course/">Course Notes</a>. [<a href="https://github.com/wdas/brdf/blob/master/src/brdfs/disney.brdf">source code</a>]</li>
<li>Walter, Bruce, et al. <cite><a href="http://www.cs.cornell.edu/~srm/publications/EGSR07-btdf.html">&ldquo;Microfacet models for refraction through rough surfaces.&rdquo;</a></cite> EGSR&rsquo;07.</li>
<li>Heitz, Eric, and Eugene d&rsquo;Eon. <cite id="ref.3"><a href="https://hal.inria.fr/hal-00996995">&ldquo;Importance Sampling Microfacet‐Based BSDFs using the Distribution of Visible Normals.&rdquo;</a></cite> EGSR&rsquo;14. [<a href="https://hal.inria.fr/hal-00996995v2/file/slides.pdf">slides</a>]</li>
</ol>

                  
    <hr>
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'shihchinw';
    var disqus_identifier = 'http:\/\/shihchin.com\/2015\/07\/implementing-disney-principled-brdf-in-arnold.html';
    var disqus_title = 'Implementing Disney Principled BRDF in Arnold';
    var disqus_url = 'http:\/\/shihchin.com\/2015\/07\/implementing-disney-principled-brdf-in-arnold.html';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


                </div>
            </div>
        </div>
    </article>

    <hr>
    
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                  <ul class="list-inline text-center">
                    
                      <li>
                        <a href="mailto:shihchin.weng@gmail.com">
                          <span class="fa-stack fa-lg">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
                          </span>
                        </a>
                      </li>
                    
                    
                    <li>
                      <a href="https://twitter.com/shihchinw">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                    <li>
                      <a href="https://github.com/shihchinw">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                  </ul>
                  <p class="copyright text-muted">Copyright © Shih-Chin</p>
                </div>
            </div>
        </div>
    </footer>

    
    <script src="http://shihchin.com/js/jquery.min.js"></script>

    
    <script src="http://shihchin.com/js/bootstrap.min.js"></script>

    
    <script src="http://shihchin.com/js/clean-blog.js"></script>

    
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-71352938-1', 'auto');
ga('send', 'pageview');
</script>


    <script src="http://shihchin.com/js/lightbox.js"></script>

    <script src="http://shihchin.com/js/jquery.event.move.js"></script>
    <script src="http://shihchin.com/js/jquery.twentytwenty.js"></script>
    

    <script>
        $(window).load(function(){
          $(".twentytwenty-container[data-orientation!='vertical']").twentytwenty({default_offset_pct: 0.7});
          $(".twentytwenty-container[data-orientation='vertical']").twentytwenty({default_offset_pct: 0.3, orientation: 'vertical'});
        });

        
        $(function() {
          return $("h1, h2, h3, h4, h5, h6").each(function(i, el) {
            var $el, icon, id;
            $el = $(el);
            id = $el.attr('id');
            icon = '<i class="fa fa-link"></i>';
            if (id) {
              return $el.append($("<a />").addClass("header-link").attr("href", "#" + id).html(icon));
            }
          });
        });
    </script>
</body>

</html>

