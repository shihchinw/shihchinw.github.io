<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=author content><title>Assign Custom Shapes' Components to Sets in Maya</title><link href=http://shihchinw.github.io/css/bootstrap.css rel=stylesheet><link href=http://shihchinw.github.io/css/clean-blog.css rel=stylesheet><link href=//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css rel=stylesheet type=text/css><link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel=stylesheet type=text/css><link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel=stylesheet type=text/css><link href='//fonts.googleapis.com/css?family=Lato:400,400italic|Open+Sans:400italic,600italic,400,600|Coda:800)' media=screen rel=stylesheet type=text/css><script src=https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js></script>
<link rel=stylesheet href=http://shihchinw.github.io/css/prettyprint.css><link rel=stylesheet href=http://shihchinw.github.io/css/lightbox.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body)})</script><link rel=stylesheet type=text/css href=http://shihchinw.github.io/css/foundation.css><link rel=stylesheet type=text/css href=http://shihchinw.github.io/css/twentytwenty.css><link rel=stylesheet type=text/css href=http://shihchinw.github.io/css/header-anchor.css><link rel="shortcut icon" type=image/png href=http://shihchinw.github.io/favicon.png><style>.katex{font-size:1.1em!important}.intro-header .overlay{background:rgba(0,0,0,.47);z-index:1;width:100%;height:100%;top:0}p+ul{margin-top:-24px}p+ol{margin-top:-24px}h1+p,h2+p,h3+p{margin-top:15px}.summary-content{text-align:justify;margin:5px 0}a.read-more-link{color:#f44336;font-weight:bolder;margin-left:5px}code>div>.table{margin-bottom:0;padding:0}code>div>.table>tbody>tr>td{border-top:none;padding:0}.container .img-responsive{padding:5px;margin:auto;-moz-box-shadow:0 0 5px rgba(0,0,0,.15);-webkit-box-shadow:0 0 5px rgba(0,0,0,.15);box-shadow:0 0 5px rgba(0,0,0,.15);-moz-border-radius:5px;-webkit-border-radius:5px;border-radius:5px;margin-top:10px;margin-bottom:10px}.twentytwenty-container .img-responsive{padding:0;margin:0 auto;-moz-box-shadow:none;-webkit-box-shadow:none;box-shadow:none;border-radius:0}.figure .img-responsive{padding:0;margin:auto;-moz-box-shadow:none;-webkit-box-shadow:none;box-shadow:none;border-radius:0;margin-top:0;margin-bottom:5px}.figure{padding:5px;margin:auto;-moz-box-shadow:0 0 10px rgba(0,0,0,.2);-webkit-box-shadow:0 0 10px rgba(0,0,0,.2);box-shadow:0 0 10px rgba(0,0,0,.2);-moz-border-radius:5px;-webkit-border-radius:5px;border-radius:5px;margin-top:15px;margin-bottom:15px;display:table}figure figcaption{text-align:center;font-size:14px;color:gray}.container li a{text-decoration:underline}.container a:hover,a:focus{background:#a6dcf3;text-decoration:none}samp{display:block;background-color:#003700;font-size:.8em;text-align:left;color:#0f0;padding:5px;white-space:pre-wrap;border-radius:5px;margin:10px 0}samp.error{color:red}blockquote p:first-child,blockquote ul:first-child,blockquote ol:first-child{margin-top:0}.container blockquote{background:#fff1e5;padding:8px;margin-top:20px;margin-bottom:20px;text-align:justify;line-height:1.5;border:dashed;border-color:#e4c9c4}.container blockquote.feedback{white-space:pre-wrap}blockquote time{font-size:80%}blockquote{color:#806565}blockquote a{color:#337ab7}span.blue{border-bottom:1px solid #a6dcf3;box-shadow:inset 0 -6px #a6dcf3}span.orange{border-bottom:1px solid #ffd18c;box-shadow:inset 0 -6px #ffd699}span.red{color:#dc1111}span.green{border-bottom:1px solid #cdf9bb;box-shadow:inset 0 -6px #cdf9bb}.tag-box{list-style:none;margin:0;padding:4px 0;overflow:hidden}.tag-box.inline li{float:left}.tag-box li{padding:4px 6px;margin:2px;background-color:#e6e6e6;-webkit-border-radius:4px;-moz-border-radius:4px;border-radius:4px}.tag-box li a{text-decoration:none}</style></head><body onload=PR.prettyPrint()><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle data-toggle=collapse data-target=#bs-example-navbar-collapse-1>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=http://shihchinw.github.io>Shih-Chin</a></div><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav navbar-right"><li><a href=http://shihchinw.github.io/>home</a></li><li><a href=http://shihchinw.github.io/page/computer-graphics.html>Computer Graphics</a></li><li><a href=http://shihchinw.github.io/page/global-illumination.html>Global Illumination</a></li><li><a href=http://shihchinw.github.io/page/arnold.html>Arnold</a></li><li><a href=http://shihchinw.github.io/page/maya.html>Maya</a></li><li><a href=http://shihchinw.github.io/post.html>Posts</a></li><li><a href=http://shihchinw.github.io/about.html>About</a></li></ul></div></div></nav><header class=intro-header><div class=overlay><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>Assign Custom Shapes' Components to Sets in Maya</h1><h2 class=subheading></h2><span class=meta>Posted by Shih-Chin on Tue, Apr 21, 2015</span></div></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><p>Recently, I tried to extend the functionalities of GPU cache in Maya with dag item selection and shader assignment. In order to achieve the seamless integration, the idea is to use face component to represent each dag item within the Alembic cache. Therefore, users can select the dag item from the cache in component mode and assign those components to a shader.</p><p><img src=http://shihchinw.github.io/images/maya/maya_api_custom_shape_comp_to_sets.jpg alt="Custom Shape Components"></p><p>This idea is pretty simple, but the implementation is not as easy as it sounds. It took me few days to figure out all the relevant interactions among the classes in Maya API. This post is about the minimum implementation steps to support component assignment and restoration of a custom shape. In order to achieve our goal, there are two main tasks needed to be done: one is <strong>selection routine</strong> the other is <strong>dummy geometry data</strong>. Before diving into the implementation details, let&rsquo;s look at the big picture first.</p><h1 id=checklist-the-minimum-requirements>Checklist: The Minimum Requirements</h1><ul><li>A custom geometry data inherited from <strong>MPxGeometryData</strong><ul><li>Only needs to implement the pure virtual functions derived from MPxGeometryData</li></ul></li><li>Inherit <strong>MPxSurfaceShape/MPxComponentShape</strong> and <strong>MPxSurfaceUI</strong> and override the following functions<ul><li><span class=blue><em><strong>for regular set assignments</strong></em></span><ul><li>geometryData()</li><li>matchComponent()</li><li>select()</li></ul></li><li><span class=blue><em><strong>for shader (render set) assignments</strong></em></span><ul><li>renderGroupComponentType()</li><li>createFullRenderGroup()</li></ul></li></ul></li></ul><h1 id=selection-and-draw>Selection and Draw</h1><p>The select procedural is implemented in <strong>MPxSurfaceUI::select()</strong>. In select(), we have to determine the selection mode and create a component object with one of these type:</p><ul><li>Vertex: MFn::kMeshVertComponent, kSubVertexComponent, kCurveCVComponent</li><li>Edge: MFn::kMeshVertComponent, etc</li><li>Face: MFn::kMeshPolygonComponent, etc</li></ul><p>I found that using component type MFn::kSetGroupComponent would <span class=red><strong>NOT</strong></span> trigger <strong>MPxSurface::componentToPlugs()</strong>, and this would make the
<strong>MPxSurfaceShape::activeComponents()</strong> always return null MObject. It means that we can&rsquo;t retrieve the activeComponents() from MPxSurfaceShape in MPxSurfaceShapeUI::draw() to render the corresponding components with desire style (ex. wireframe).</p><h2 id=few-more-experiments>Few More Experiments</h2><ul><li>At first, I tried to maintain the activeComponents myself, but I found it&rsquo;s almost impossible to reproduce the selection behavior with modifier (i.e. ctrl or shift key).</li><li>The other interesting thing I found is that, when we do selection in the component mode, the MPxSurfaceUI::select() would be invoked when the mouse cursor is within the shape&rsquo;s bounding box <strong>regardless we press the mouse button or not!</strong></li><li>The select() is also used for the Maya&rsquo;s hidden command <code>dagObjectHit</code>. When we right click the mouse at our custom shape, it should invoke the select() for object hit query. If it doesn&rsquo;t, we should double check the selection mask to make it works, otherwise our custom <code>dagMenuProc</code> would not work as expected.</li></ul><p>If everything works properly at this stage, we should be able to select the component from mouse event or from a command like <code>select -r myShape.f[0]</code>.</p><blockquote><p>Since I use face component to represent the dag-id within the Alembic cache, there is no actual data need to be stored in the plug. Therefore, I simply use the default implementation of componentToPlugs() without any overriding in my custom shape class. This configuration works for me so far.</p></blockquote><h1 id=support-per-face-shader-assignment>Support Per-Face Shader Assignment</h1><p>In order to support faces assignment for a custom shape, we need two extra function overrides:</p><ul><li>renderGroupComponentType()<ul><li>should always return one of these types:<ul><li>MFn::kMeshPolygonComponent</li><li>MFn::kSubdivFaceComponent</li><li>MFn::kSurfaceFaceComponent</li></ul></li></ul></li><li>createFullRenderGroup()<ul><li>create a component object whose type is <span class=orange><strong>identical</strong></span> to renderGroupComponentType()</li></ul></li></ul><p>Now we can assign face components of our custom shape to a shader in the same fashion as Maya does for its native geometry types. However, although we can see the component information stored in the shape&rsquo;s attribute in Maya ASCII file, but the assignments can&rsquo;t be restored from the file yet!</p><p><img src=http://shihchinw.github.io/images/maya/maya_api_componts_in_ma.jpg alt="Components in ma"></p><h1 id=where-is-component-info-stored>Where Is Component Info Stored?</h1><p>The place where component data is stored depends on <strong>whether there is a history or not.</strong> When there is a history of the shape, the component is stored in the <code>groupParts</code> node. <code>groupParts</code> is used for appending the component data to a group in geometry data whose id comes the from a <code>groupId</code> node.</p><p>After we delete the history of the shape, the component data would be transferred to the shape node, but the <code>groupId</code> nodes still keep their connections. From the devkit/apiMesh sample, we found that it can restore the component data <strong>ONLY if its history presents</strong>. Now, our question is, how do we transfer the component data to our custom shape?</p><h1 id=restore-the-components-in-sets-without-history>Restore the Components in Sets without History</h1><p>Here is the most subtle part, it took me two days to hack this out. We don&rsquo;t need to maintain the component data in our custom shape ourselves. All these things are done by Maya automatically if we provide it the appropriate geometry data via the <strong>MPxSurfaceShape::geometryData().</strong> If we return a null Mobject, we won&rsquo;t be able to restore the shapes&rsquo; components in sets when we reopen the file, even if the component data are correctly saved in the <code>myShape.objectGroups[*].objectGrpCompList</code>. It seems that Maya always query the component data from geometryData(). Therefore, the last thing we need to do is to override the <strong>geometryData()</strong> properly, take apiMesh for example:</p><pre class="prettyprint linenums lang-cpp">
MObject apiMesh::geometryData() const
//
// Description
//
//    Returns the data object for the surface. This gets
//    called internally for grouping (set) information.
//
{
    apiMesh* nonConstThis = (apiMesh*)this;
    MDataBlock datablock = nonConstThis->forceCache();
    MObject geomAttr = hasHistory() ? inputSurface : outputSurface;
    MDataHandle handle = datablock.inputValue(geomAttr);
    return handle.data();
}
</pre><p>Finally, we have a custom shape supporting face assignment to a shader as Maya does for its geometry shapes. Writing a custom shape is never an easy task, we need to override many derived virtual functions for seamless integration. Hope this post would be helpful for anyone who wants to implement their own custom shape. Please feel free to drop me a note if there is any missing information. ;)</p><h1 id=references>References</h1><ul><li><a href="http://help.autodesk.com/view/MAYAUL/2015/ENU/?guid=__files_Shapes_htm">Maya Developer Help - Shapes</a></li><li><a href=http://around-the-corner.typepad.com/adn/2012/09/custom-shapes-in-the-maya-api-1.html>Custom Shapes in the Maya API</a> [<a href=http://around-the-corner.typepad.com/files/customShapeSamples.zip>plug-ins examples</a>] @Around the Corner<ul><li>Step by step examples about custom shape. Extremely helpful!</li></ul></li><li><a href=http://around-the-corner.typepad.com/adn/2012/09/maya-deformer-architecture.html>Maya’s Deformer Architecture</a> @Around the Corner<ul><li>Clear explanation for the concepts of groupParts and groupId</li></ul></li></ul><hr><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//shihchinw.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></article><hr><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:shihchin.weng@gmail.com><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/shihchinw><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/shihchinw><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright © Shih-Chin</p></div></div></div></footer><script src=http://shihchinw.github.io/js/jquery.min.js></script>
<script src=http://shihchinw.github.io/js/bootstrap.min.js></script>
<script src=http://shihchinw.github.io/js/clean-blog.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-L4ZM8YZ5G6"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-L4ZM8YZ5G6",{anonymize_ip:!1})}</script><script src=http://shihchinw.github.io/js/lightbox.js></script>
<script src=http://shihchinw.github.io/js/jquery.event.move.js></script>
<script src=http://shihchinw.github.io/js/jquery.twentytwenty.js></script>
<script>$(window).load(function(){$(".twentytwenty-container[data-orientation!='vertical']").twentytwenty({default_offset_pct:.7}),$(".twentytwenty-container[data-orientation='vertical']").twentytwenty({default_offset_pct:.3,orientation:"vertical"})}),$(function(){return $("h1, h2, h3, h4, h5, h6").each(function(e,t){var n=$(t),s=n.attr("id"),o='<i class="fa fa-link"></i>';if(s)return n.append($("<a />").addClass("header-link").attr("href","#"+s).html(o))})})</script></body></html>